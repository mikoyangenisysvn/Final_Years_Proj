Design and Implementation of a PWM IP Core (Pulse Width Modulation Intellectual Property) on FPGA
ğŸ“Œ Báº£n tÃ³m táº¯t tÃ­nh nÄƒng

Äá» tÃ i xÃ¢y dá»±ng má»™t PWM IP core cÃ³ thá»ƒ cáº¥u hÃ¬nh Ä‘Æ°á»£c qua APB bus, há»— trá»£:

Äá»™ phÃ¢n giáº£i 16-bit cho tÃ­n hiá»‡u PWM.

Prescaler Ä‘iá»u chá»‰nh táº§n sá»‘ PWM tá»« clock há»‡ thá»‘ng.

So sÃ¡nh duty cycle Ä‘á»ƒ Ä‘iá»u khiá»ƒn xung ra.

Cáº¥u hÃ¬nh thÃ´ng qua thanh ghi (Register Map):

Thiáº¿t láº­p duty cycle.

Báº­t/táº¯t PWM.

Äiá»u chá»‰nh prescaler.

Äá»c tráº¡ng thÃ¡i hoáº¡t Ä‘á»™ng.

Ngáº¯t (Interrupt) khi duty Ä‘áº¡t ngÆ°á»¡ng (tÃ¹y chá»n).

CÃ³ thá»ƒ má»Ÿ rá»™ng Ä‘á»ƒ há»— trá»£ multi-channel PWM.

ğŸ“Œ Kiáº¿n trÃºc tá»•ng thá»ƒ

PWM IP core Ä‘Æ°á»£c thiáº¿t káº¿ tá»« cÃ¡c khá»‘i sau:

APB Interface

Vai trÃ²: Giao tiáº¿p giá»¯a CPU/SoC vÃ  IP Core.

Chuyá»ƒn lá»‡nh ghi/Ä‘á»c tá»« bus APB vÃ o thanh ghi Ä‘iá»u khiá»ƒn.

Register Block

Vai trÃ²: LÆ°u trá»¯ cÃ¡c giÃ¡ trá»‹ cáº¥u hÃ¬nh tá»« CPU (duty, prescaler, enable, interrupt enable, status...).

Xuáº¥t tÃ­n hiá»‡u Ä‘iá»u khiá»ƒn sang cÃ¡c khá»‘i con khÃ¡c.

Prescaler

Vai trÃ²: Chia clock há»‡ thá»‘ng thÃ nh xung clock cháº­m hÆ¡n Ä‘á»ƒ táº¡o táº§n sá»‘ PWM phÃ¹ há»£p.

Counter

Vai trÃ²: Bá»™ Ä‘áº¿m 16-bit cháº¡y theo xung tá»« prescaler.

Cung cáº¥p giÃ¡ trá»‹ hiá»‡n táº¡i Ä‘á»ƒ so sÃ¡nh vá»›i duty.

Comparator

Vai trÃ²: So sÃ¡nh giÃ¡ trá»‹ counter vá»›i giÃ¡ trá»‹ duty.

Xuáº¥t tÃ­n hiá»‡u PWM_out (1 khi counter < duty, 0 khi counter â‰¥ duty).

Control Logic

Vai trÃ²:

Quáº£n lÃ½ báº­t/táº¯t PWM.

KÃ­ch hoáº¡t interrupt khi duty Ä‘áº¡t ngÆ°á»¡ng (náº¿u báº­t).

Reset counter khi cáº§n.

Interrupt Block (tuá»³ chá»n)

Vai trÃ²: Sinh tÃ­n hiá»‡u ngáº¯t vá» CPU khi PWM Ä‘áº¡t Ä‘iá»u kiá»‡n cáº¥u hÃ¬nh.

PWM Top (PWM_top)

Vai trÃ²: TÃ­ch há»£p toÃ n bá»™ cÃ¡c khá»‘i trÃªn vÃ o má»™t kiáº¿n trÃºc hoÃ n chá»‰nh.

Xuáº¥t ra tÃ­n hiá»‡u PWM_out.

ğŸ“Œ Register Map cho PWM IP Core
Äá»‹a chá»‰ (Offset)	TÃªn thanh ghi	Kiá»ƒu	MÃ´ táº£
0x00	CONTROL	R/W	Thanh ghi Ä‘iá»u khiá»ƒn chung
0x04	STATUS	R	Thanh ghi tráº¡ng thÃ¡i
0x08	DUTY_CYCLE	R/W	Cáº¥u hÃ¬nh giÃ¡ trá»‹ duty cycle (16-bit)
0x0C	PRESCALER	R/W	GiÃ¡ trá»‹ chia clock (16-bit)
0x10	INT_ENABLE	R/W	Cho phÃ©p/báº­t táº¯t interrupt
0x14	INT_STATUS	R/W1C	Tráº¡ng thÃ¡i interrupt (ghi 1 Ä‘á»ƒ xÃ³a cá»)
ğŸ“Œ Chi tiáº¿t tá»«ng thanh ghi
1. CONTROL (0x00)
Bit	TÃªn	Kiá»ƒu	MÃ´ táº£
[0]	PWM_EN	R/W	1 = báº­t PWM, 0 = táº¯t PWM
[1]	CNT_RESET	W	1 = reset counter vá» 0
[2]	INT_CLR	W	XÃ³a cá» interrupt thá»§ cÃ´ng
[31:3]	RSV	-	DÃ nh cho má»Ÿ rá»™ng
2. STATUS (0x04)
Bit	TÃªn	Kiá»ƒu	MÃ´ táº£
[0]	PWM_ACTIVE	R	Cho biáº¿t PWM Ä‘ang cháº¡y
[1]	CNT_ZERO	R	Cho biáº¿t counter Ä‘ang á»Ÿ 0
[2]	DUTY_MATCH	R	Counter == DUTY
[31:3]	RSV	-	DÃ nh cho má»Ÿ rá»™ng
3. DUTY_CYCLE (0x08)
Bit	TÃªn	Kiá»ƒu	MÃ´ táº£
[15:0]	DUTY_VAL	R/W	GiÃ¡ trá»‹ duty cycle (so vá»›i counter)
[31:16]	RSV	-	KhÃ´ng dÃ¹ng
4. PRESCALER (0x0C)
Bit	TÃªn	Kiá»ƒu	MÃ´ táº£
[15:0]	PRESC_VAL	R/W	GiÃ¡ trá»‹ chia clock (N+1)
[31:16]	RSV	-	KhÃ´ng dÃ¹ng
5. INT_ENABLE (0x10)
Bit	TÃªn	Kiá»ƒu	MÃ´ táº£
[0]	INT_EN	R/W	Cho phÃ©p interrupt
[1]	DUTY_MATCH_IE	R/W	Ngáº¯t khi counter == DUTY
[2]	CNT_ZERO_IE	R/W	Ngáº¯t khi counter = 0
[31:3]	RSV	-	KhÃ´ng dÃ¹ng
6. INT_STATUS (0x14)
Bit	TÃªn	Kiá»ƒu	MÃ´ táº£
[0]	INT_FLAG	R/W1C	1 = cÃ³ ngáº¯t, ghi 1 Ä‘á»ƒ xÃ³a
[1]	DUTY_MATCH_IF	R/W1C	1 = counter == DUTY, ghi 1 Ä‘á»ƒ xÃ³a
[2]	CNT_ZERO_IF	R/W1C	1 = counter = 0, ghi 1 Ä‘á»ƒ xÃ³a
[31:3]	RSV	-	KhÃ´ng dÃ¹ng
ğŸ“Œ Luá»“ng hoáº¡t Ä‘á»™ng

CPU ghi vÃ o PRESCALER Ä‘á»ƒ chá»n táº§n sá»‘ PWM.

CPU ghi vÃ o DUTY_CYCLE Ä‘á»ƒ chá»n Ä‘á»™ rá»™ng xung.

CPU báº­t PWM_EN trong thanh ghi CONTROL Ä‘á»ƒ cháº¡y PWM.

Counter sáº½ cháº¡y â†’ Comparator so sÃ¡nh vá»›i DUTY â†’ xuáº¥t PWM_OUT.

Náº¿u báº­t interrupt â†’ khi counter = 0 hoáº·c counter = DUTY sáº½ sinh ngáº¯t.


# Block diagram â€” PWM IP Core (16-bit)

DÆ°á»›i Ä‘Ã¢y lÃ  **block diagram** dáº¡ng ASCII + mÃ´ táº£ tÃ­n hiá»‡u Ä‘á»ƒ báº¡n cÃ³ thá»ƒ chÃ¨n tháº³ng vÃ o bÃ¡o cÃ¡o hoáº·c dÃ¹ng lÃ m hÆ°á»›ng dáº«n triá»ƒn khai RTL.

```
                                +----------------------+
                                |       APB BUS        |
                                | psel, penable, pwrite|
                                | paddr[11:0], pwdata  |
                                | prdata[31:0], pready |
                                +----------+-----------+
                                           |
                                           v
                                +----------------------+
                                |      APB IF /        |
                                |    WR_EN, RD_EN      |
                                +----------+-----------+
                                           |
                                           v
                                +----------------------+
                                |      REGISTER        |
                                | (CONTROL / STATUS /  |
                                |  DUTY / PRESCALER /  |
                                |  INT_ENABLE / INT_ST)|
                                +--+---+----+---+---+--+
             CONTROL signals / |      |    |   |    |   |
             register outputs  |      |    |   |    |   |
                              v       v    v   v    v   v
                       +--------+  +------+ +-----+  +--------+
                       | Pres-  |  |Counter| |Comp.|  |Interrupt|
                       | caler  |  |(16-bit)| |(per |  |  Block |
                       | (div)  |  | period | |chanel)|  |(flags)|
                       +---+----+  +---+---+ +--+--+  +----+---+
                           |           |        |          |
                           | slow_clk  |count   | pwm_out  |
                           |           |value   | (per ch) |
                           v           v        v          v
                        (clock)     counter  comparator  INT -> CPU
                                     value     decision
                                          \      /
                                           \    /
                                            \  /
                                             \/
                                         PWM_TOP
                                         (aggregates)
                                            |
                                            +--> pwm_out[ch0]
                                            +--> pwm_out[ch1]
                                            +--> pwm_out[ch2]
                                            +--> pwm_out[ch3]
```

---

## Giáº£i thÃ­ch ngáº¯n (má»‘i liÃªn há»‡ tÃ­n hiá»‡u)

* **APB IF**

  * Nháº­n `psel, penable, pwrite, paddr, pwdata` tá»« bus.
  * Sinh `wr_en`, `rd_en`, truyá»n tá»›i `REGISTER`.
  * Tráº£ `prdata` ra APB.

* **REGISTER**

  * Thanh ghi: `CONTROL (PWM_EN, CNT_RESET, MODE)`, `STATUS`, `DUTY_CHx`, `PRESCALER`, `INT_ENABLE`, `INT_STATUS`.
  * Xuáº¥t cÃ¡c tÃ­n hiá»‡u Ä‘iá»u khiá»ƒn: `pwm_en`, `cnt_reset`, `mode`, `prescaler_val`, `duty_ch[x]`, `int_enable_*`.

* **PRESCALER**

  * Nháº­n `clk` há»‡ thá»‘ng vÃ  `prescaler_val` â†’ xuáº¥t `slow_clk` (xung cho Counter).
  * Náº¿u prescaler = 0 â†’ slow\_clk = clk (hoáº·c xá»­ lÃ½ tÃ¹y thiáº¿t káº¿).

* **COUNTER (16-bit)**

  * Äáº¿m theo `slow_clk`.
  * Mode: up (0 â†’ period) hoáº·c up-down (center-aligned) náº¿u mode báº­t.
  * Dá»«ng hoáº·c reset khi `pwm_en = 0` hoáº·c `cnt_reset = 1`.
  * Xuáº¥t `counter_value[15:0]` tá»›i Comparator vÃ  STATUS.

* **COMPARATOR (per channel)**

  * Má»—i kÃªnh: so sÃ¡nh `counter_value` vá»›i `duty_ch[i]`.
  * Náº¿u `counter < duty` â†’ `pwm_out = 1`, ngÆ°á»£c láº¡i 0.
  * Há»— trá»£ thÃªm tÃ­nh nÄƒng inverted/phase-shift náº¿u muá»‘n má»Ÿ rá»™ng.

* **INTERRUPT BLOCK**

  * Sinh cá» khi `counter == 0` (end of period) hoáº·c `counter == duty` (duty match) náº¿u tÆ°Æ¡ng á»©ng bit `INT_ENABLE` báº­t.
  * Ghi vÃ o `INT_STATUS`; CPU cÃ³ thá»ƒ clear báº±ng write-1 (W1C) hoáº·c báº±ng `CONTROL.INT_CLR`.

* **PWM\_TOP**

  * Táº­p há»£p táº¥t cáº£, xuáº¥t nhiá»u `pwm_out[ch]` ra chÃ¢n FPGA/SoC.

---

## Top-level I/O gá»£i Ã½ cho RTL (tÃªn tÃ­n hiá»‡u)

* Inputs:

  * `sys_clk`, `sys_rst_n`
  * `psel`, `pwrite`, `penable`
  * `paddr[11:0]`, `pwdata[31:0]`
* Outputs:

  * `prdata[31:0]`, `pready`, `pslverr` (APB)
  * `pwm_out[N-1:0]` (N = sá»‘ kÃªnh, vÃ­ dá»¥ 4)
  * `irq` (tÃ­n hiá»‡u ngáº¯t ra SoC)

---

## Gá»£i Ã½ mapping register â†’ module

* `CONTROL` â†’ output `pwm_en`, `mode`, `cnt_reset` â†’ Counter / Control Logic
* `PRESCALER` â†’ input `prescaler_val` â†’ Prescaler
* `DUTY_CHx` â†’ `duty_ch[x]` â†’ Comparator x
* `INT_ENABLE` â†’ `int_enable_*` â†’ Interrupt Block
* `INT_STATUS` / `STATUS` â†’ inputs read tá»« Interrupt / Counter / Comparator

---

## Kiá»ƒm thá»­ (testbench) â€” checklist ngáº¯n

1. Reset toÃ n bá»™, Ä‘á»c register default.
2. Ghi `prescaler`, `period`, `duty` vÃ  báº­t `PWM_EN`.
3. Quan sÃ¡t `pwm_out`: duty ratio = duty/period.
4. Test `cnt_reset` â€” counter trá»Ÿ vá» 0.
5. Test interrupt: báº­t `INT_ENABLE`, kiá»ƒm tra cá» INT\_STATUS khi counter==0 vÃ  counter==duty.
6. Test multi-channel: cÃ¡c kÃªnh cÃ³ duty khÃ¡c nhau táº¡o ra wave khÃ¡c nhau.
7. Mode center-aligned (náº¿u cÃ³): kiá»ƒm tra shape xung.

